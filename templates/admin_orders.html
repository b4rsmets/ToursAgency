{% extends "base.html" %}

{% block title %}Управление заказами - Туристическое Агентство{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4"><i class="fas fa-tasks me-2"></i>Управление заказами</h1>

    <!-- Канбан доска -->
    <div class="row">
        <!-- Колонка Ожидание -->
        <div class="col-lg-3 mb-4">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Ожидание
                        <span class="badge bg-dark ms-2">{{ orders|selectattr("status", "equalto", "Ожидание")|list|length }}</span>
                    </h5>
                </div>
                <div class="card-body kanban-column" style="min-height: 500px;">
                    {% for order in orders if order.status == 'Ожидание' %}
                    <div class="card mb-3 kanban-card">
                        <div class="card-body">
                            <h6 class="card-title">{{ order.tour.name }}</h6>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-user me-1"></i>{{ order.user.username }}
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-calendar me-1"></i>{{ order.start_date }} - {{ order.end_date }}
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-users me-1"></i>{{ order.guests_count }} чел.
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-ruble-sign me-1"></i>{{ "%.2f"|format(order.total_price) }} ₽
                            </div>

                            {% if order.special_requests %}
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-info w-100" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#requests{{ order.id }}">
                                    <i class="fas fa-comment me-1"></i>Пожелания
                                </button>
                                <div class="collapse mt-2" id="requests{{ order.id }}">
                                    <div class="card card-body small">
                                        {{ order.special_requests }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="mt-3">
                                <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}"
                                      class="mb-2">
                                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                        <option value="Ожидание" selected>Ожидание</option>
                                        <option value="Подтвержден">Подтвержден</option>
                                        <option value="Отменен">Отменен</option>
                                    </select>
                                </form>
                                <div class="d-grid">
                                    <a href="{{ url_for('delete_order', order_id=order.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Вы уверены, что хотите удалить заказ #{{ order.id }}?')">
                                        <i class="fas fa-trash me-1"></i>Удалить
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>Нет заказов</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Колонка Подтвержден -->
        <div class="col-lg-3 mb-4">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>Подтвержден
                        <span class="badge bg-dark ms-2">{{ orders|selectattr("status", "equalto", "Подтвержден")|list|length }}</span>
                    </h5>
                </div>
                <div class="card-body kanban-column" style="min-height: 500px;">
                    {% for order in orders if order.status == 'Подтвержден' %}
                    <div class="card mb-3 kanban-card">
                        <div class="card-body">
                            <h6 class="card-title">{{ order.tour.name }}</h6>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-user me-1"></i>{{ order.user.username }}
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-calendar me-1"></i>{{ order.start_date }} - {{ order.end_date }}
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-users me-1"></i>{{ order.guests_count }} чел.
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-ruble-sign me-1"></i>{{ "%.2f"|format(order.total_price) }} ₽
                            </div>

                            {% if order.special_requests %}
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-info w-100" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#requests{{ order.id }}">
                                    <i class="fas fa-comment me-1"></i>Пожелания
                                </button>
                                <div class="collapse mt-2" id="requests{{ order.id }}">
                                    <div class="card card-body small">
                                        {{ order.special_requests }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="mt-3">
                                <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}"
                                      class="mb-2">
                                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                        <option value="Ожидание">Ожидание</option>
                                        <option value="Подтвержден" selected>Подтвержден</option>
                                        <option value="Завершен">Завершен</option>
                                        <option value="Отменен">Отменен</option>
                                    </select>
                                </form>
                                <div class="d-grid">
                                    <a href="{{ url_for('delete_order', order_id=order.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Вы уверены, что хотите удалить заказ #{{ order.id }}?')">
                                        <i class="fas fa-trash me-1"></i>Удалить
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <p>Нет заказов</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Колонка Завершен -->
        <div class="col-lg-3 mb-4">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-flag-checkered me-2"></i>Завершен
                        <span class="badge bg-dark ms-2">{{ orders|selectattr("status", "equalto", "Завершен")|list|length }}</span>
                    </h5>
                </div>
                <div class="card-body kanban-column" style="min-height: 500px;">
                    {% for order in orders if order.status == 'Завершен' %}
                    <div class="card mb-3 kanban-card">
                        <div class="card-body">
                            <h6 class="card-title">{{ order.tour.name }}</h6>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-user me-1"></i>{{ order.user.username }}
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-calendar me-1"></i>{{ order.start_date }} - {{ order.end_date }}
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-users me-1"></i>{{ order.guests_count }} чел.
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-ruble-sign me-1"></i>{{ "%.2f"|format(order.total_price) }} ₽
                            </div>

                            {% if order.special_requests %}
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-info w-100" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#requests{{ order.id }}">
                                    <i class="fas fa-comment me-1"></i>Пожелания
                                </button>
                                <div class="collapse mt-2" id="requests{{ order.id }}">
                                    <div class="card card-body small">
                                        {{ order.special_requests }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="mt-3">
                                <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}"
                                      class="mb-2">
                                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                        <option value="Подтвержден">Подтвержден</option>
                                        <option value="Завершен" selected>Завершен</option>
                                    </select>
                                </form>
                                <div class="d-grid">
                                    <a href="{{ url_for('delete_order', order_id=order.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Вы уверены, что хотите удалить заказ #{{ order.id }}?')">
                                        <i class="fas fa-trash me-1"></i>Удалить
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-flag-checkered fa-2x mb-2"></i>
                        <p>Нет заказов</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Колонка Отменен -->
        <div class="col-lg-3 mb-4">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-times-circle me-2"></i>Отменен
                        <span class="badge bg-dark ms-2">{{ orders|selectattr("status", "equalto", "Отменен")|list|length }}</span>
                    </h5>
                </div>
                <div class="card-body kanban-column" style="min-height: 500px;">
                    {% for order in orders if order.status == 'Отменен' %}
                    <div class="card mb-3 kanban-card">
                        <div class="card-body">
                            <h6 class="card-title">{{ order.tour.name }}</h6>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-user me-1"></i>{{ order.user.username }}
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-calendar me-1"></i>{{ order.start_date }} - {{ order.end_date }}
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-users me-1"></i>{{ order.guests_count }} чел.
                            </div>
                            <div class="small text-muted mb-2">
                                <i class="fas fa-ruble-sign me-1"></i>{{ "%.2f"|format(order.total_price) }} ₽
                            </div>

                            {% if order.special_requests %}
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-info w-100" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#requests{{ order.id }}">
                                    <i class="fas fa-comment me-1"></i>Пожелания
                                </button>
                                <div class="collapse mt-2" id="requests{{ order.id }}">
                                    <div class="card card-body small">
                                        {{ order.special_requests }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="mt-3">
                                <div class="d-grid gap-2">
                                    <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}">
                                        <select name="status" class="form-select form-select-sm mb-2" onchange="this.form.submit()">
                                            <option value="Отменен" selected>Отменен</option>
                                            <option value="Ожидание">Восстановить</option>
                                        </select>
                                    </form>
                                    <a href="{{ url_for('delete_order', order_id=order.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Вы уверены, что хотите удалить заказ #{{ order.id }}?')">
                                        <i class="fas fa-trash me-1"></i>Удалить
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                        <p>Нет заказов</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Статистика заказов</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-warning">{{ orders|selectattr("status", "equalto", "Ожидание")|list|length }}</h3>
                                <p class="mb-0">Ожидают</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-success">{{ orders|selectattr("status", "equalto", "Подтвержден")|list|length }}</h3>
                                <p class="mb-0">Подтверждены</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-info">{{ orders|selectattr("status", "equalto", "Завершен")|list|length }}</h3>
                                <p class="mb-0">Завершены</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h3 class="text-danger">{{ orders|selectattr("status", "equalto", "Отменен")|list|length }}</h3>
                                <p class="mb-0">Отменены</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.kanban-column {
    background-color: #f8f9fa;
}

.kanban-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.card.border-warning .kanban-card {
    border-left-color: #ffc107;
}

.card.border-success .kanban-card {
    border-left-color: #198754;
}

.card.border-info .kanban-card {
    border-left-color: #0dcaf0;
}

.card.border-danger .kanban-card {
    border-left-color: #dc3545;
}

.kanban-card .card-body {
    padding: 1rem;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .col-lg-3 {
        margin-bottom: 1rem;
    }

    .kanban-column {
        min-height: 300px !important;
    }
}
</style>

<script>
// Автоматическое обновление страницы каждые 30 секунд для актуальности данных
setTimeout(function() {
    window.location.reload();
}, 30000);

// Плавное раскрытие пожеланий
document.addEventListener('DOMContentLoaded', function() {
    const collapseButtons = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseButtons.forEach(button => {
        button.addEventListener('click', function() {
            const target = document.querySelector(this.getAttribute('data-bs-target'));
            if (target.classList.contains('show')) {
                this.innerHTML = '<i class="fas fa-comment me-1"></i>Пожелания';
            } else {
                this.innerHTML = '<i class="fas fa-comment me-1"></i>Скрыть';
            }
        });
    });
});
</script>
{% endblock %}